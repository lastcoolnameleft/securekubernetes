
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../scenario_2_attack/">
      
      
        <link rel="next" href="../bonus_challenges/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Scenario 2 Defense - AKS Capture the Flag</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#persistence-scenario-2-defense" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="AKS Capture the Flag" class="md-header__button md-logo" aria-label="AKS Capture the Flag" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 20q-2.28 0-3.89-1.57Q1 16.85 1 14.58q0-1.95 1.17-3.48 1.18-1.53 3.08-1.95.63-2.3 2.5-3.72Q9.63 4 12 4q2.93 0 4.96 2.04Q19 8.07 19 11q1.73.2 2.86 1.5 1.14 1.28 1.14 3 0 1.88-1.31 3.19T18.5 20Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AKS Capture the Flag
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Scenario 2 Defense
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/lastcoolnameleft/aks-ctf" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lastcoolnameleft/aks-ctf
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="AKS Capture the Flag" class="md-nav__button md-logo" aria-label="AKS Capture the Flag" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 20q-2.28 0-3.89-1.57Q1 16.85 1 14.58q0-1.95 1.17-3.48 1.18-1.53 3.08-1.95.63-2.3 2.5-3.72Q9.63 4 12 4q2.93 0 4.96 2.04Q19 8.07 19 11q1.73.2 2.86 1.5 1.14 1.28 1.14 3 0 1.88-1.31 3.19T18.5 20Z"/></svg>

    </a>
    AKS Capture the Flag
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lastcoolnameleft/aks-ctf" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lastcoolnameleft/aks-ctf
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scenario_1_attack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scenario 1 Attack
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scenario_1_defense/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scenario 1 Defense
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scenario_2_attack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scenario 2 Attack
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Scenario 2 Defense
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Scenario 2 Defense
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#backstory" class="md-nav__link">
    <span class="md-ellipsis">
      Backstory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backstory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#name-blue" class="md-nav__link">
    <span class="md-ellipsis">
      Name: Blue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#motivations" class="md-nav__link">
    <span class="md-ellipsis">
      Motivations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defense" class="md-nav__link">
    <span class="md-ellipsis">
      Defense
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Defense">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identifying-the-issue" class="md-nav__link">
    <span class="md-ellipsis">
      Identifying the Issue
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_challenges/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus Challenges
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_hints/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus Challenge Hints
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_1_walkthrough/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus 1 Walkthrough
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_2_walkthrough/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus 2 Walkthrough
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../wrapup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wrap Up
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#backstory" class="md-nav__link">
    <span class="md-ellipsis">
      Backstory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backstory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#name-blue" class="md-nav__link">
    <span class="md-ellipsis">
      Name: Blue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#motivations" class="md-nav__link">
    <span class="md-ellipsis">
      Motivations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defense" class="md-nav__link">
    <span class="md-ellipsis">
      Defense
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Defense">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identifying-the-issue" class="md-nav__link">
    <span class="md-ellipsis">
      Identifying the Issue
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="persistence-scenario-2-defense">Persistence: Scenario 2 Defense<a class="headerlink" href="#persistence-scenario-2-defense" title="Permanent link">&para;</a></h1>
<h2 id="backstory">Backstory<a class="headerlink" href="#backstory" title="Permanent link">&para;</a></h2>
<h3 id="name-blue">Name: <strong>Blue</strong><a class="headerlink" href="#name-blue" title="Permanent link">&para;</a></h3>
<ul>
<li>Still overworked</li>
<li>Still can only do the bare minimum</li>
<li>Uses the defaults when configuring systems</li>
<li>Usually gets blamed for stability or security issues</li>
</ul>
<h3 id="motivations">Motivations<a class="headerlink" href="#motivations" title="Permanent link">&para;</a></h3>
<ul>
<li>A week after the first incident, <strong>Blue</strong> gets paged at 3am because “the website is slow again”.</li>
<li><strong>Blue</strong>, puzzled, takes another look.</li>
<li><strong>Blue</strong> decides to dust off the résumé “just in case”.</li>
</ul>
<h2 id="defense">Defense<a class="headerlink" href="#defense" title="Permanent link">&para;</a></h2>
<p><strong>Blue</strong> is paged again with the same message as last time. What is going on? Could this be the same problem again?</p>
<h3 id="identifying-the-issue">Identifying the Issue<a class="headerlink" href="#identifying-the-issue" title="Permanent link">&para;</a></h3>
<p>Let's run some basic checks again to see if we can find random workloads:</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl get pods --all-namespaces</span>
</code></pre></div>
<p>There does not appear to be any unusual workloads running on our cluster.</p>
<p>Just to be sure, let's check our cluster's resource consumption:</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl top node</span>
</code></pre></div>
<p>and</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl top pod --all-namespaces</span>
</code></pre></div>
<p>So far, everything looks normal. What gives?</p>
<p>Hold on. We installed <code>falco</code> last time and it is throwing us alerts in StackDriver.</p>
<h1 id="issue-how-to-do-in-log-analytics">ISSUE How to do in Log Analytics?<a class="headerlink" href="#issue-how-to-do-in-log-analytics" title="Permanent link">&para;</a></h1>
<p>Let's look the Events tile in the AKS resource.</p>
<p><img alt="opa admission gatekeeper" src="../img/r00t-event.png" /></p>
<p>Huh. This is odd. An unrecognized container, but no other information to go off of? </p>
<p>Let's look at Azure Defender for Cloud</p>
<p><img alt="opa admission gatekeeper" src="../img/r00t-security-alert.png" /></p>
<p>We can see that a privileged container was launched with the same name.</p>
<hr />
<p>ISSUE: THIS IS THE OLD CONTENT. It's got more details, but not sure of equivalent CLI/portal steps</p>
<p>In a new <a href="https://console.cloud.google.com/logs/viewer" target="_blank">StackDriver window</a>, let's run the query:</p>
<div class="highlight"><pre><span></span><code><span class="go">resource.type=&quot;k8s_container&quot;</span>
<span class="go">resource.labels.container_name:&quot;falco&quot;</span>
<span class="go">jsonPayload.rule=&quot;Launch Privileged Container&quot; OR jsonPayload.rule=&quot;Terminal shell in container&quot;</span>
</code></pre></div>
<p>We're looking for <code>container</code> logs from <code>falco</code> where triggered rules are privileged containers or interactive shells.</p>
<p>In a new <a href="https://console.cloud.google.com/logs/viewer" target="_blank">StackDriver window</a>, let's run this query:</p>
<div class="highlight"><pre><span></span><code><span class="go">resource.type=k8s_cluster</span>
<span class="go">protoPayload.request.spec.containers.image=&quot;alpine&quot;</span>
</code></pre></div>
<p>So, we see a few things:</p>
<ol>
<li>A create event that was authorized with the <code>system:serviceaccount:dev:default</code> serviceaccount in the <code>dev</code> namespace.</li>
<li>A pod named <code>r00t</code> got created</li>
<li>The pod command is <code>nsenter --mount=/proc/1/ns/mnt -- /bin/bash</code></li>
<li>The <code>securityContext</code> is <code>privileged: true</code></li>
<li>The <code>hostPID</code> is set to <code>true</code></li>
</ol>
<p>This is not looking good. Can we see what this container did?</p>
<p>In a new <a href="https://console.cloud.google.com/logs/viewer" target="_blank">StackDriver window</a>, let's search for this <code>r00t</code> container logs:</p>
<div class="highlight"><pre><span></span><code><span class="go">resource.type=&quot;k8s_container&quot;</span>
<span class="go">resource.labels.pod_name:r00t</span>
</code></pre></div>
<p>Wow. We can see someone was running commands from this container.</p>
<p>But wait, they can run docker commands? How can they talk to the docker on the host from the container? OH NO! They must have broken out of the container and by this point they're on the host!</p>
<p>That <code>bitcoinero</code> container again must be what's causing slowness. But, they're trying to do something else.</p>
<p>They tried to create a pod, but failed. So, they created a Service and an Endpoint. They must be trying to open a backdoor of some sort to get back in later.</p>
<p>In cloud shell, let's check if those exist:</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl -n kube-system get svc,ep</span>
</code></pre></div>
<p>That's one sneaky hacker, for sure. But, jokes on them, We're not using service mesh.</p>
<p>Let's delete that service (the endpoint will be deleted too):</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl -n kube-system delete svc/istio-mgmt</span>
</code></pre></div>
<p>But, I want to know how did they get in in the first place?!?!?! The <code>create</code> event authorized because of the <code>dev:default</code> serviceaccount. So, what is in <code>dev</code> namespace that led to someone taking over the entire host?</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl -n dev get pods</span>
</code></pre></div>
<p>There is an <code>app</code>, a <code>db</code>, and a <code>dashboard</code>. Wait a second! Could it be an exposed dashboard?</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl -n dev logs $(kubectl -n dev get pods -o name | grep dashboard) -c dashboard</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="go">kubectl -n dev logs $(kubectl -n dev get pods -o name | grep dashboard) -c authproxy</span>
</code></pre></div>
<p>It is an exposed dashboard. That's how they got in. There is <code>GET /webshell</code> in authproxy logs with the source IP.</p>
<p>We might want to revoke that serviceaccount token: </p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl -n dev delete $(kubectl -n dev get secret -o name| grep default)</span>
</code></pre></div>
<p>And perhaps disable the automatic mounting of serviceaccount tokens by setting <code>automountServiceAccountToken: false</code> in the pod spec, if the dashboard doesn't need it. </p>
<p>But, how can we mitigate this further?</p>
<p>The attacker ran a privileged container, which they shouldn't have been able to. So, we should block that. I remember a talk at KubeCon this week about <a href="https://github.com/open-policy-agent/gatekeeper" target="_blank">Open-Policy-Agent/Gatekeeper</a> that gets deployed as an admission controller.</p>
<p>That should work because an admission controller is a piece of code that intercepts requests to the Kubernetes API server after the request is authenticated and authorized.</p>
<p><img alt="opa admission gatekeeper" src="../img/opa.png" /></p>
<p>So, we should set two policies:</p>
<ol>
<li>Deny privileged containers.</li>
<li>Allow only the images we expect to have in <code>dev</code> and <code>prd</code> namespaces.</li>
</ol>
<p>First, let's apply Gatekeeper itself:</p>
<div class="highlight"><pre><span></span><code><span class="go">--enable-addons</span>
<span class="go">az aks enable-addons --addons azure-policy --name $AKS_NAME --resource-group $RESOURCE_GROUP</span>

<span class="gp"># </span>OLD<span class="w"> </span>COMMAND
<span class="gp"># </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/securekubernetes/securekubernetes/master/manifests/security2.yaml
</code></pre></div>
<p>Second, let's apply the policies. If you receive an error about <code>no matches for kind... in version ...</code>, this means Gatekeeper has not kicked into gear yet. Wait a few seconds then re-apply policies:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>ISSUE:<span class="w"> </span>Must<span class="w"> </span>use<span class="w"> </span>Portal.<span class="w">  </span>See:<span class="w"> </span>https://learn.microsoft.com/en-us/azure/governance/policy/concepts/policy-for-kubernetes#assign-a-policy-definition
<span class="gp"># </span>ISSUE:<span class="w"> </span>Policies<span class="w"> </span>take<span class="w"> </span>take<span class="w"> </span>20m<span class="w"> </span>to<span class="w"> </span>sync!
<span class="gp"># </span>https://learn.microsoft.com/en-us/azure/aks/use-azure-policy#validate-an-azure-policy-is-running

<span class="gp"># </span>OLD<span class="w"> </span>COMMAND
<span class="go">kubectl apply -f https://raw.githubusercontent.com/securekubernetes/securekubernetes/master/manifests/security2-policies.yaml</span>
</code></pre></div>
<p>Let's see if this actually works by trying to run some containers that violate these policies.</p>
<p>First, let's try to run privileged container:</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl apply -f - &lt;&lt;EOF</span>
<span class="go">apiVersion: v1</span>
<span class="go">kind: Pod</span>
<span class="go">metadata:</span>
<span class="go">  name: nginx</span>
<span class="go">  labels:</span>
<span class="go">    app: nginx</span>
<span class="go">spec:</span>
<span class="go">  containers:</span>
<span class="go">  - name: nginx</span>
<span class="go">    image: nginx</span>
<span class="go">    ports:</span>
<span class="go">    - containerPort: 80</span>
<span class="go">    securityContext:</span>
<span class="go">      privileged: true</span>
<span class="go">EOF</span>
</code></pre></div>
<p>We see that Kubernetes denied this request for 2 reasons (not whitelisted image and privileged), as expected.</p>
<p>Let's try running a non-whitelisted image:</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl -n dev run alpine --image=alpine --restart=Never</span>
</code></pre></div>
<p>We see that Kubernetes rejected this request again due to image not being whitelisted/allowed, as expected.</p>
<p>Can we still run pods that meet/satisfy the Gatekeeper policies? Let's find out:</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl -n dev run ubuntu --image=ubuntu --restart=Never</span>
</code></pre></div>
<p>Yes, looks like we can run pods that satisfy the policies and requirements we set on our cluster.</p>
<p>Even though we applied Falco and Gatekeeper, we should not continue to use this cluster since it has been compromised. We should create a new cluster and re-deploy our applications there once we've hardened and secured it enough.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/lastcoolnameleft/aks-ctf" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>